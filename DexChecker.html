<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©mon GO Collection Viewer</title>
    <style>
        
.modern-card {
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  background: rgb(209, 209, 209);
  border-radius: 16px;
  padding: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  gap: 8px;
  position: relative;
}
.modern-card-top {
  padding: 8px;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
}

.modern-card-bottom {
  background-color: whitesmoke;
  padding: 8px;
  opacity: 0.8375;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
}

.modern-header {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.modern-name {
  font-weight: bold;
  font-size: 1.2rem;
}

.modern-types {
  display: flex;
  justify-content: center;
  gap: 4px;
}

.type-badge-icon {
  width: 22px;
  height: 22px;
  object-fit: contain;
}

.type-icon-row .type-badge-icon {
  transform: scale(0.9);            /* shrink to 80% */
}

.type-icon-row {
  margin-bottom: 12px;              /* spacing between types and moves */
}


.modern-image {
  display: flex;
  justify-content: center;
}

.pokemon-img {
    min-width: 192px;
    min-height: 192px;
  max-width: 256px;
  max-height: 256px;
}

.modern-cp {
  font-weight: bold;
  font-size: 1.4rem;
  color: #d12b2b;
}

.modern-info-row {
  display: flex;
  justify-content: space-around;
  font-size: 0.85rem;
  color: #666;
}

.info-block.label {
  font-weight: bold;
  opacity: 0.7;
}

.modern-moves {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  flex-direction: column;
  gap: 4px;
}

.modern-ivs {
  display: flex;
  justify-content: space-around;
  font-size: 1.1rem;
  font-weight: bold;
}

.iv-labels {
  display: flex;
  justify-content: space-around;
  font-size: 1rem;
  color: #555;
}


        :root {
            --primary-color: #e53935;
            --secondary-color: #2196f3;
            --accent-color: #ffc107;
            --dark-color: #333;
            --light-color: #f5f5f5;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --card-bg: white;
            --text-color: #333;
            --muted-text: #777;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
         body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 85%;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--dark-color);
            color: var(--text-color);
            line-height: 1.6;
        } 
        
        h1, h2, h3 {
            color: var(--primary-color);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .controls {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 3px 10px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-section {
            margin-bottom: 15px;
        }
        
        .control-section:last-child {
            margin-bottom: 0;
        }
        
        .control-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .filters-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .filters-row:last-child {
            margin-bottom: 0;
        }

        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
        }
        
        select, input {
            min-width: 150px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: auto;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        button:hover {
            background-color: #c62828;
        }
        
        button.secondary {
            background-color: var(--secondary-color);
        }
        
        button.secondary:hover {
            background-color: #1976d2;
        }
        
        button.accent {
            background-color: var(--accent-color);
            color: var(--dark-color);
        }
        
        button.accent:hover {
            background-color: #ffb300;
        }
        
        .stats-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 3px 10px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .pokemon-card.selected {
            box-shadow: 0 0 0 3px red;
            border-radius: 12px;
        }

        /* .pokemon-card.selected {
            outline: 2px solid red;
            outline-offset: -2px;
            border-radius: 12px;
        } */


        .stats-container.selected-mode .stat-box {
            border: 3px solid red;
            border-radius: 8px;
            padding: 4px;
        }
        .stats-container.filtered-mode {
            border: 2px solid gray;
            border-radius: 10px;
            padding: 8px;
        }

        .stats-container.filtered-mode .stat-box {
            border: 2px solid gray;
            border-radius: 8px;
            padding: 4px;
        }

        .stat-box {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }



        
        .stat-value {
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 15px;
            color: var(--muted-text);
        }
        
        .selection-tools {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 3px 10px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .selection-tools h3 {
            margin-bottom: 10px;
        }
        
        .search-string {
            padding: 10px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }
        
        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        /*---Pokemon Card styles---*/
        .pokemon-card {
        background: white;
        border-radius: 20px;
        padding: 12px;
        margin: 8px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        font-family: 'Arial', sans-serif;
        }

.pokemon-img {
  width: 100px;
  height: 100px;
  margin: auto;
}

.pokemon-name {
  font-weight: bold;
  font-size: 1.5em;
  margin-top: 4px;
}

/* Shared styles */
.pvp-rank-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  font-size: 20px;
  z-index: 10;
  padding: 2px;
  background-color: white;
  border-radius: 50%;
  border: 2px solid transparent;
  pointer-events: auto;
}

/* Rank-specific borders */
.rank-1 {
  border-color: gold;
}

.rank-2 {
  border-color: silver;
}

.rank-3 {
  border-color: #cd7f32; /* bronze */
}

.shiny-icon {
  position: absolute;
  top: 4px;
  left: 4px;
  width: 20px;
  height: 20px;
  z-index: 10;
  background-color: white;
  border-radius: 50%;
  border: 2px solid #ffd700; /* gold border */
  padding: 1px;
  pointer-events: auto;
}


.type-icons {
  margin-top: 4px;
}

.type-badge-icon {
  width: 24px;
  height: 24px;
  margin: 0 2px;
  vertical-align: middle;
}

.cp-text {
  font-size: 1.4em;
  font-weight: bold;
  color: #d12b2b;
  margin-top: 6px;
}

.info-row {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
  font-size: 0.9em;
  color: #666;
}

.info-block {
  width: 33%;
}

.info-types {
  width: 33%;
  opacity: 0.7;
  font-weight: bold;
}

.moves {
  margin-top: 6px;
}

.iv-row {
  display: flex;
  justify-content: space-around;
  font-size: 1.2em;
  font-weight: bold;
  margin-top: 10px;
}

.iv-icons {
  display: flex;
  justify-content: space-around;
  font-size: 1em;
  color: #444;
  margin-top: -4px;
}

        
        
        /*---New Type-based Filtering Grid ---*/
        
        .type-filter-grid {
            display: grid;
            grid-template-columns: repeat(6, auto);
            gap: 6px;
            margin-bottom: 1rem;
            justify-content: center;
        }
        .type-filter-grid .type-badge {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s ease;
            user-select: none;
        }
        
        .type-filter-grid .type-badge.selected {
            opacity: 1;
            border: 2px solid #000;
            border-radius: 8px;
            box-shadow: 0 0 10px 3px rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        
        .clear-type-button {
            margin: 10px ;
            display: block;
            padding: 6px 12px;
            font-weight: bold;
            background: #ddd;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .clear-type-button:hover {
            background: #AFD;
        }

        .move-icon-wrap {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 4px;
        }

        .move-icon-wrap img.type-badge-icon {
        width: 20px;
        height: 20px;
        }


        .pokemon-types {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 6px;
        }
        
        .move-badges {
            display: flex;
            flex-wrap: wrap;
            flex-direction: column;
            gap: 4px;
            justify-content: center;
            margin-top: 4px;
        }
        
        
        .type-badge {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            line-height: 1;
        }
        
        
        .type-badge.type-bug     { background-color: #A8B820; color: white; }
        .type-badge.type-dark    { background-color: #705848; color: white; }
        .type-badge.type-dragon  { background-color: #7038F8; color: white; }
        .type-badge.type-electric{ background-color: #F8D030; color: #000; }
        .type-badge.type-fairy   { background-color: #EE99AC; color: white; }
        .type-badge.type-fighting{ background-color: #C03028; color: white; }
        .type-badge.type-fire    { background-color: #F08030; color: white; }
        .type-badge.type-flying  { background-color: #A890F0; color: #000; }
        .type-badge.type-ghost   { background-color: #705898; color: white; }
        .type-badge.type-grass   { background-color: #78C850; color: white; }
        .type-badge.type-ground  { background-color: #E0C068; color: white; }
        .type-badge.type-ice     { background-color: #98D8D8; color: #000; }
        .type-badge.type-normal  { background-color: #A8A878; color: #000; }
        .type-badge.type-poison  { background-color: #A040A0; color: white; }
        .type-badge.type-psychic { background-color: #F85888; color: white; }
        .type-badge.type-rock    { background-color: #B8A038; color: white; }
        .type-badge.type-steel   { background-color: #B8B8D0; color: #000; }
        .type-badge.type-water   { background-color: #6890F0; color: white; }

        /* .type-badge.type-STABbug     { background-color: #A8B820; color: white; }
        .type-badge.type-STABdark    { background-color: #705848; color: white; }
        .type-badge.type-STABdragon  { background-color: #7038F8; color: white; }
        .type-badge.type-STABelectric{ background-color: #F8D030; color: #000; }
        .type-badge.type-STABfairy   { background-color: #EE99AC; color: white; }
        .type-badge.type-STABfighting{ background-color: #C03028; color: white; }
        .type-badge.type-STABfire    { background-color: #F08030; color: white; }
        .type-badge.type-STABflying  { background-color: #A890F0; color: #000; }
        .type-badge.type-STABghost   { background-color: #705898; color: white; }
        .type-badge.type-STABgrass   { background-color: #78C850; color: white; }
        .type-badge.type-STABground  { background-color: #E0C068; color: white; }
        .type-badge.type-STABice     { background-color: #98D8D8; color: #000; }
        .type-badge.type-STABnormal  { background-color: #A8A878; color: #000; }
        .type-badge.type-STABpoison  { background-color: #A040A0; color: white; }
        .type-badge.type-STABpsychic { background-color: #F85888; color: white; }
        .type-badge.type-STABrock    { background-color: #B8A038; color: white; }
        .type-badge.type-STABsteel   { background-color: #B8B8D0; color: #000; }
        .type-badge.type-STABwater   { background-color: #6890F0; color: white; } */

        /* .type-badge.type-bug     { background-color: #b0b86c; color: white; }
        .type-badge.type-dark    { background-color: #70645c; color: white; }
        .type-badge.type-dragon  { background-color: #b799f7; color: white; }
        .type-badge.type-electric{ background-color: #f7e494; color: #000; }
        .type-badge.type-fairy   { background-color: #edc2cc; color: white; }
        .type-badge.type-fighting{ background-color: #bf7775; color: white; }
        .type-badge.type-fire    { background-color: #f0b890; color: white; }
        .type-badge.type-flying  { background-color: #ccc0f0; color: #000; }
        .type-badge.type-ghost   { background-color: #857999; color: white; }
        .type-badge.type-grass   { background-color: #9fc78b; color: white; }
        .type-badge.type-ground  { background-color: #e0d0a4; color: white; }
        .type-badge.type-ice     { background-color: #b8d9d9; color: #000; }
        .type-badge.type-normal  { background-color: #a8a891; color: #000; }
        .type-badge.type-poison  { background-color: #a170a1; color: white; }
        .type-badge.type-psychic { background-color: #f7a8c0; color: white; }
        .type-badge.type-rock    { background-color: #b8ac77; color: white; }
        .type-badge.type-steel   { background-color: #c5c5d1; color: #000; }
        .type-badge.type-water   { background-color: #adc1f0; color: white; } */
        
        .pokemonTypes {
            margin: 4px 0;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        
        .typeLabel {
            background-color: #eee;
            border-radius: 6px;
            padding: 2px 6px;
            font-size: 11px;
            color: #444;
        }
        
        .ivContainer {
            display: flex;
            justify-content: space-around;
            margin-top: 6px;
        }
        
        .ivBox {
            background-color: #f3f3f3;
            border-radius: 8px;
            padding: 4px 6px;
            width: 48px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 11px;
        }

        .ivLabel {
            font-weight: bold;
        }

        .ivEmoji {
            font-size: 14px;
            margin: 2px 0;
        }

        .ivValue {
            font-size: 13px;
            font-weight: bold;
        }
        
        
        .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            padding: 3px 6px;
            border-radius: 4px;
            color: white;
        }
        
        .pokemon-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .pokemon-number {
            color: var(--muted-text);
            font-weight: bold;
			font-size: 14px;
            margin-bottom: 10px;
        }
        
        .pokemon-cp {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .stat-label {
            font-size: 10px;
            color: var(--muted-text);
        }
        
        .gender-male {
            color: #2196f3;
        }
        
        .gender-female {
            color: #e91e63;
        }
        
        .gender-neutral {
            color: #9e9e9e;
        }
        
        .move {
            font-size: 11px;
            color: #555;
            margin-top: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background-color: white;
            border-radius: 0 0 10px 10px;
        }
        
        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
        }
        
        .modal-details {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .detail-pokemon-info .pokemon-types {
            display: inline-flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .detail-pokemon-info .type-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            vertical-align: middle;
        }
        
        
        .detail-pokemon-sprite {
            text-align: center;
            flex: 1;
            min-width: 200px;
        }
        
        .detail-pokemon-sprite img {
            max-width: 300px;
            max-height: 300px;
        }
        
        .detail-pokemon-info {
            flex: 2;
            min-width: 300px;
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section h3 {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .detail-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .detail-stat-box {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 10px;
            min-width: 80px;
            text-align: center;
        }
        
        .detail-moves {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .detail-move {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 10px;
            min-width: 120px;
        }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .detail-table tr {
            border-bottom: 1px solid #eee;
        }
        
        .detail-table th, .detail-table td {
            padding: 8px;
            text-align: left;
        }
        
        .detail-table th {
            color: var(--muted-text);
            font-weight: normal;
            width: 40%;
        }
        
        .detail-table td {
            font-weight: 500;
        }
        
        .stat-bar-container {
            width: 100%;
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            margin-top: 5px;
        }
        
        .stat-bar {
            height: 100%;
            border-radius: 3px;
        }
        
        .stat-bar-attack {
            background-color: #ff5252;
        }
        
        .stat-bar-defence {
            background-color: #2196f3;
        }
        
        .stat-bar-stamina {
            background-color: #4caf50;
        }
        
        .progress-bar {
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
            background-color: #e0e0e0;
            height: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .pokemon-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .stat-box {
                min-width: 100%;
            }
            
            .modal-content {
                width: 95%;
            }
        }
        
        /* Toggle switch */
        .toggle-container {
            display: flex;
            align-items: center;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label {
            font-size: 14px;
        }
        
        /* Loading spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .load-more-container {
            text-align: center;
            margin-top: 20px;
        }
		.alpha-nav {
            position: fixed;
			top: 50%;
			right: 10px;
			transform: translateY(-50%);
			background: rgba(255,255,255,0.9);
			border-radius: 10px;
			padding: 5px;
			box-shadow: 0 0 5px rgba(0,0,0,0.1);
			z-index: 100;
		}
        
		.alpha-nav ul {
            list-style: none;
			padding: 0;
			margin: 0;
			text-align: center;
		}
        
		.alpha-nav li {
            padding: 4px 6px;
			cursor: pointer;
			font-weight: bold;
			font-size: 14px;
			color: var(--primary-color);
		}
        
		.alpha-nav li:hover {
            background-color: var(--light-color);
		}
        
        
        
        #stickySearchContainer {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 10px 0;
        }
        
        
        .pokemon-card[data-iv-percent] {
            position: relative;
            background-image: linear-gradient(
                to bottom,
                var(--iv-gradient-start),
                var(--iv-gradient-end)
                );
                background-blend-mode: multiply;
            }
            
/* Radio button styles */
.filter-radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}
.filter-toggle-button {
  padding: 4px 10px;
  font-weight: bold;
  border-radius: 6px;
  border: 2px solid #666;
  background-color: #eee;
  color: #333;
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s;
}

.filter-toggle-button:hover {
  background-color: #ccc;
}

.filter-toggle-button.and-mode {
  background-color: #c0392b;
  color: white;
  border-color: #c0392b;
}


.filter-radio {
    display: none;
}

.filter-radio-label {
    padding: 6px 12px;
    border-radius: 4px;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease;
}

.filter-radio:checked + .filter-radio-label {
    background-color: var(--primary-color);
    color: white;
}

.filter-radio-label:hover {
    background-color: #e0e0e0;
}

.filter-flash {
    background-color: #ff4d4d !important;
    transition: background-color 0.2s ease;
}

.filter-pill {
    padding: 5px 10px;
    margin: 3px;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    color: #000;
}
.filter-pill.active {
    background-color: #e53935;
    color: #fff;
}
.filter-pill-label:hover {
    background-color: #e0e0e0;
}


/* Inline checkbox + dropdown group layout */
.inline-checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    width: auto;
}

.tight-label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    line-height: 1.2;
    white-space: nowrap;
}

.tight-label input[type="checkbox"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    margin: 0;
    padding: 0;
    border: 2px solid #999;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
    position: relative;
    box-sizing: border-box;
}

/* Checkmark when checked */
.tight-label input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 5px;
    width: 4px;
    height: 8px;
    border: solid #333;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}


/* Shadow Pokemon - Darker purple aura with smoke effect */
.pokemon-card.shadow {
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
}

.pokemon-card.shadow::before {
    content: '';
    position: absolute;
    inset: -30%;
    background: radial-gradient(circle at 50% 50%, rgba(91, 15, 153, 0.35) 0%, transparent 70%);
    animation: pulseAura 3s infinite ease-in-out alternate, floatSmoke 25s infinite linear;
    z-index: 0;
    pointer-events: none;
    filter: blur(4px);
    opacity: 0.9;
}

    

    
    /* Ensure content stays above backgrounds */
    .pokemon-card > * {
        position: relative;
        z-index: 1;
    }

    .type-badge.stab {
    border: 1px solid black;
}

.type-badge.faded {
    filter: brightness(1.25) saturate(0.5);
    }


</style>

<style>
.card {
  border-radius: 1.5rem;
  border: 4px solid #a3e28f;
  padding: 1rem;
  background-color: white;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  height: 100%;
}
.card-cp {
  font-size: 2rem;
  font-weight: bold;
  color: red;
  text-align: center;
  margin-top: 0.5rem;
}
.card-name {
  font-size: 1.5rem;
  font-weight: 800;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.25rem;
}
.card-gender {
  font-size: 1.25rem;
}
.card-types {
  display: flex;
  justify-content: center;
  gap: 0.25rem;
  margin: 0.5rem 0;
}
.card-moves {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-top: 0.5rem;
  margin-bottom: 1rem;
}
.move {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  border-radius: 1rem;
  padding: 0.25rem 0.75rem;
  margin: 0.25rem 0;
  font-weight: 600;
  color: white;
}
.move.fast {
  background-color: #69c350;
}
.move.charged {
  background-color: #a640c9;
}
.move-placeholder {
  height: 2rem;
}
.card-stats {
  display: flex;
  justify-content: space-around;
  margin-top: auto;
  padding-top: 0.5rem;
  border-top: 1px solid #ccc;
}
.stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-weight: bold;
}
.stat img {
  width: 24px;
  height: 24px;
  margin-bottom: 0.25rem;
}
</style>

</head>
<body>
  
    <h1>Pok√©mon GO Collection Viewer</h1>
    
    <div class="controls">
        <div class="control-section">
            <h3>File Operations</h3>
            <div class="filters-row">
                <button id="loadSampleData">Load Sample Data</button>
                <button id="uploadJsonBtn">Upload JSON File</button>
                <button id="exportSelectedBtn" class="secondary">Export Selected</button>
                <select id="accountSelector">
                    <option value="">Select Account</option>
                </select>
                
            </div>
        </div>
        
        <div class="control-section">
            <h3>Basic Filters</h3>
            <div class="filters-row">
                <select id="sortBy">
                    
                    <option value="number">Sort by Pok√©dex #</option>
                    <option value="cp">Sort by CP</option>
                    <option value="name">Sort by Name</option>
                    <option value="attack">Sort by Attack</option>
                    <option value="defence">Sort by Defense</option>
                    <option value="stamina">Sort by Stamina</option>
                </select>
                
                
                
                <select id="filterStatus">
                    <option value="all">All Pok√©mon</option>
                    <option value="shiny">Shiny</option>
                    <option value="shadow">Shadow</option>
                    <option value="lucky">Lucky</option>
                </select>
                
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="text" id="searchInput" placeholder="Search here...">
                    <button id="searchHelpBtn" title="Search help" style="padding: 4px 8px; font-weight: bold; font-size: 16px; cursor: pointer;">?</button>
                </div>
            </div>
            <div class="filter-row" style="margin-top: 10px;">
                <label for="filterLogicToggle" style="margin-right: 8px;">Filter Mode:</label>
                <button id="filterLogicToggle" class="filter-toggle-button" onclick="toggleFilterLogic()"title="Toggle between OR (match any filter) and AND (match all filters) mode">OR</button>
              </div>
              
                
                <div class="filter-radio-group">
                    <input type="button" id="filterNone" class="filter-radio" value="None" onclick="clearSpecialFilters()">
                    <label for="filterNone" class="filter-radio-label" title="Clear all special filters">None</label>

                    <input type="checkbox" id="filterShiny" class="filter-radio" onchange="filterAndSortPokemon()">
                    <label for="filterShiny" class="filter-radio-label" title="Show only ‚ú® shiny Pok√©mon">Shinies</label>
                    
                    <input type="checkbox" id="filterLucky" class="filter-radio" onchange="filterAndSortPokemon()">
                    <label for="filterLucky" class="filter-radio-label" title="Show only üçÄ lucky Pok√©mon">Luckys</label>
                    
                    <input type="checkbox" id="filterShadow" class="filter-radio" onchange="filterAndSortPokemon()">
                    <label for="filterShadow" class="filter-radio-label" title="Show only üòà shadow Pok√©mon">Shadows</label>
                    
                    <input type="checkbox" id="filterPurified" class="filter-radio" onchange="filterAndSortPokemon()">
                    <label for="filterPurified" class="filter-radio-label" title="Show only üëº purified Pok√©mon">Purified</label>
                    
                    <input type="checkbox" id="filterHundo" class="filter-radio" onchange="filterAndSortPokemon()">
                    <label for="filterHundo" class="filter-radio-label" title="Show only üíØ 100% IV Pok√©mon">Hundos</label>
                    
                    <input type="checkbox" id="filterNundo" class="filter-radio" onchange="filterAndSortPokemon()">
                    <label for="filterNundo" class="filter-radio-label" title="Show only 0% IV Pok√©mon">Nundos</label>
                    
                    <input type="checkbox" id="filterNickname" class="filter-radio" onchange="filterAndSortPokemon()">
                    <label for="filterNickname" class="filter-radio-label" title="Show only Pok√©mon with nicknames">Nicknames</label>
                    
                </div>
                
            </div>
            
            <div class="control-section">
                <h3>Advanced Filters</h3>
                <label for="filterRegion">Region:</label>
                <select id="filterRegion">
                  <option value="">All Regions</option>
                  <option value="KANTO">Kanto</option>
                  <option value="JOHTO">Johto</option>
                  <option value="HOENN">Hoenn</option>
                  <option value="SINNOH">Sinnoh</option>
                  <option value="UNOVA">Unova</option>
                  <option value="KALOS">Kalos</option>
                  <option value="ALOLA">Alola</option>
                  <option value="GALARIAN">Galar</option>
                  <option value="HISUI">Hisui</option>
                  <option value="PALDEA">Paldea</option>
                </select>
                <div class="filters-row">
                    
                <!-- Type Badges filtering -->
                <button id="clear-type-filters" class="clear-type-button">Clear Type Filters</button>
                <div id="type-filter" class="type-filter-grid"></div>

                <!-- Move dropdown filtering -->
                <div style="display: flex; align-items: center; gap: 8px;">
                    <select id="filterFastMove" onclick="updateFastMoveDropdown()">
                        <option value="">Fast Moves</option>
                  </select>

                <button id="toggleMoveLink" title="Toggle move filter linking"
                    style="font-size: 20px; background: none; border: none; cursor: pointer;">üîÉ</button>

                    <select id="filterChargedMove" onclick="updateChargedMoveDropdown()">
                        <option value="">Charged Moves</option>
                  </select>
                </div>

                  
                
                <div style="display: flex; align-items: center; gap: 8px;">
                    <select id="filterGender" style="height: 36px; padding: 4px 8px; font-size: 14px;">
                        <option value="">Any Gender</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                        <option value="GENDERLESS">Genderless</option>
                    </select>
                  </div>
                  

                
                <!-- Special Forms filtering -->
                <div class="inline-checkbox-group">
                    <button type="button" id="filterAltFormsOnly" class="filter-pill" onclick="toggleFilterState(this, 'AltFormsOnly')">All Forms</button>
                    <select id="filterForm">
                        <option value="">Forms</option>
                    </select>
                </div>
                
                <div class="inline-checkbox-group">
                    <button type="button" id="filterCostumedOnly" class="filter-pill" onclick="toggleFilterState(this, 'CostumedOnly')">All Costumes</button>
                    <select id="filterCostume">
                        <option value="">Costumes</option>
                    </select>
                </div>
                

            </div>
            
            <div class="filters-row">
                <div class="toggle-container">
                    <label class="switch">
                        <input type="checkbox" id="toggleAdvancedFilters">
                        <span class="slider"></span>
                    </label>
                    <span class="toggle-label">Show Stat Filters</span>
                </div>
            </div>
            
            <div id="advancedFiltersContainer" class="hidden">
                <div class="filters-row">
                    <div style="display: flex; flex-direction: column; min-width: 150px;">
                        <label for="cpMin">CP Range:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="cpMin" placeholder="Min" style="min-width: 70px; width: 70px;">
                            <input type="number" id="cpMax" placeholder="Max" style="min-width: 70px; width: 70px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; min-width: 150px;">
                        <label for="attackMin">Attack IV:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="attackMin" placeholder="Min" min="0" max="15" style="min-width: 70px; width: 70px;">
                            <input type="number" id="attackMax" placeholder="Max" min="0" max="15" style="min-width: 70px; width: 70px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; min-width: 150px;">
                        <label for="defenceMin">Defense IV:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="defenceMin" placeholder="Min" min="0" max="15" style="min-width: 70px; width: 70px;">
                            <input type="number" id="defenceMax" placeholder="Max" min="0" max="15" style="min-width: 70px; width: 70px;">
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; min-width: 150px;">
                        <label for="staminaMin">Stamina IV:</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="staminaMin" placeholder="Min" min="0" max="15" style="min-width: 70px; width: 70px;">
                            <input type="number" id="staminaMax" placeholder="Max" min="0" max="15" style="min-width: 70px; width: 70px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="stats-container" id="statsContainer">
        <div class="stat-box">
            <div class="stat-value" id="totalPokemon">0</div>
            <div class="stat-label">                Total Pok√©mon <span id="totalStatLabelSuffix" style="font-weight: normal;"></span>
            </div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="uniquePokemon">0</div>
            <div class="stat-label">                Unique Pok√©mon<span id="uniqueStatLabelSuffix" style="font-weight: normal;"></span>
            </div>
        </div>
        <div class="stat-box shiny-stat">
            <div class="stat-value" id="shinyCount">0</div>
            <div class="stat-label">                Shiny <span id="shinyStatLabelSuffix" style="font-weight: normal;"></span>

            </div>        </div>
        <div class="stat-box shadow-stat">
            <div class="stat-value" id="shadowCount">0</div>
            <div class="stat-label">                Shadow <span id="shadowStatLabelSuffix" style="font-weight: normal;"></span>

            </div>        </div>
        <div class="stat-box lucky-stat">
            <div class="stat-value" id="luckyCount">0</div>
            <div class="stat-label">                Lucky <span id="luckyStatLabelSuffix" style="font-weight: normal;"></span>

            </div>        </div>
        <div class="stat-box">
            <div class="stat-value" id="avgCp">0</div>
            <div class="stat-label">                CP <span id="cpStatLabelSuffix" style="font-weight: normal;"></span>

            </div>        </div>
        <div class="stat-box">
            <div class="stat-value" id="avgIv">0%</div>
            <div class="stat-label">                IV <span id="ivStatLabelSuffix" style="font-weight: normal;"></span>

            </div>
            </div>
    </div>
    
    <div class="selection-tools">
        <h3>Selection Tools</h3>
        <div class="filters-row">
            <button id="selectAllBtn">Select All Visible</button>
            <button id="deselectAllBtn">Deselect All</button>
            <span id="selectedCount" style="margin-left: auto;">0 selected</span>
        </div>
    </div>

    
    <div id="pokemonGrid" class="pokemon-grid">
        <!-- Pok√©mon cards will be inserted here -->
    </div>
    
    <div class="load-more-container">
        <button id="loadMoreBtn" class="hidden">Load More</button>
    </div>
    
    <!-- Modal for detailed Pok√©mon view -->
    <div id="pokemonModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Pok√©mon Details</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-details" id="modalDetails">
                    <!-- Details will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeModalBtn">Close</button>
            </div>
        </div>
    </div>

<!-- Include static data scripts -->
<!-- <script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/typeIcons.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/window.pokeFormTypings.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/window.pokeFormTypings.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/window.moveTypings.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/window.formRegionOverrides.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/window.specialSearchOptions.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/window.typingBackgrounds.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/greatLeagueRankings.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/ultraLeagueRankings.js"></script>
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/window.baseStatTotals.js"></script> -->
<script src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/main/Data/pogoData.js"></script>





<script>
        console.log("Script loaded");

document.getElementById('searchHelpBtn').addEventListener('click', () => {
    document.getElementById('searchHelpModal').classList.remove('hidden');
});

function closeSearchHelpModal() {
    document.getElementById('searchHelpModal').classList.add('hidden');
}


        function toggleFilterState(button, filterKey) {
        button.classList.toggle('active');
        // Simulate internal checkbox state (if needed elsewhere)
        window[`filter${filterKey}State`] = button.classList.contains('active');
        filterAndSortPokemon();
    }

        
    // Global variables
let useAndLogic = false; // false = OR (default), true = AND
let pokemonData = {};
let filteredPokemonIds = [];
let selectedPokemonIds = new Set();
let allMoves = new Set();
let allForms = new Set();
let allCostumes = new Set();
let displayLimit = 50;
let currentlyDisplayed = 0;
let masterUrl = "";
let moveDropdownsLinked = true;
let uploadedFiles = {};  // { accountName: [ { date: ..., data: ... } ] }





let regionTypings = {
    "KANTO": [1-151],
    "JOHTO": [152-251],
    "HOENN": [252-386],
    "SINNOH": [387-493],
    "UNOVA": [494-649],
    "KALOS": [650-721],
    "ALOLA": [722-807],
    "UNKNOWN": [808,809],
    "GALAR": [810-898],
    "HISUI": [899-905],
    "PALDEA": [906-1024],
}


let numberToTypes = {};

// DOM Elements
const elements = {
    pokemonGrid: document.getElementById('pokemonGrid'),
    searchInput: document.getElementById('searchInput'),
	sortBy: document.getElementById('sortBy'),
    filterStatus: document.getElementById('filterStatus'),
    filterFastMove: document.getElementById('filterFastMove'),
    filterChargedMove: document.getElementById('filterChargedMove'),
    filterGender: document.getElementById('filterGender'),
    filterForm: document.getElementById('filterForm'),
    filterCostume: document.getElementById('filterCostume'),
    filterRegion: document.getElementById('filterRegion'),
    loadSampleDataBtn: document.getElementById('loadSampleData'),
    uploadJsonBtn: document.getElementById('uploadJsonBtn'),
    advancedFiltersToggle: document.getElementById('toggleAdvancedFilters'),
    advancedFiltersContainer: document.getElementById('advancedFiltersContainer'),
    cpMin: document.getElementById('cpMin'),
    cpMax: document.getElementById('cpMax'),
    attackMin: document.getElementById('attackMin'),
    attackMax: document.getElementById('attackMax'),
    defenceMin: document.getElementById('defenceMin'),
    defenceMax: document.getElementById('defenceMax'),
    staminaMin: document.getElementById('staminaMin'),
    staminaMax: document.getElementById('staminaMax'),
    selectAllBtn: document.getElementById('selectAllBtn'),
    deselectAllBtn: document.getElementById('deselectAllBtn'),
    selectedCount: document.getElementById('selectedCount'),
    exportSelectedBtn: document.getElementById('exportSelectedBtn'),
    // Stats elements
    totalPokemon: document.getElementById('totalPokemon'),
    uniquePokemon: document.getElementById('uniquePokemon'),
    shinyCount: document.getElementById('shinyCount'),
    shadowCount: document.getElementById('shadowCount'),
    luckyCount: document.getElementById('luckyCount'),
    avgCp: document.getElementById('avgCp'),
    avgIv: document.getElementById('avgIv'),
    // Modal elements
    pokemonModal: document.getElementById('pokemonModal'),
    modalTitle: document.getElementById('modalTitle'),
    modalDetails: document.getElementById('modalDetails'),
    closeModal: document.getElementById('closeModal'),
    closeModalBtn: document.getElementById('closeModalBtn'),
    // Load more button
    loadMoreBtn: document.getElementById('loadMoreBtn'),
    // Radio buttons
    filterNone: document.getElementById('filterNone'),
    filterShiny: document.getElementById('filterShiny'),
    filterLucky: document.getElementById('filterLucky'),
    filterShadow: document.getElementById('filterShadow'),
    filterPurified: document.getElementById('filterPurified'),
    filterHundo: document.getElementById('filterHundo'),
    filterNundo: document.getElementById('filterNundo'),
    filterNickname: document.getElementById('filterNickname')

};

const selectedTypes = new Set();
function renderTypeFilters() {
    const container = document.getElementById('type-filter');
    TYPE_LIST.forEach(type => {
        const span = document.createElement('span');
        span.className = `type-badge type-${type.toLowerCase()}`;
        span.textContent = type;

        // ‚úÖ THIS IS THE CLICK HANDLER
        document.getElementById('clear-type-filters').onclick = () => {
        selectedTypes.clear();
        document.querySelectorAll('#type-filter .type-badge').forEach(badge => {
            badge.classList.remove('selected');
        });
        filterAndSortPokemon();
    };

        span.onclick = () => {
            if (selectedTypes.has(type)) {
                selectedTypes.delete(type);
                span.classList.remove('selected');
            } else {
                selectedTypes.add(type);
                span.classList.add('selected');
            }
            filterAndSortPokemon();
        };

        container.appendChild(span);
    });
}

renderTypeFilters();

// Utility functions

function getPvpRankBadge(rankIndex) {
  if (rankIndex === 0) return "ü•á";
  if (rankIndex === 1) return "ü•à";
  if (rankIndex === 2) return "ü•â";
  if (rankIndex >= 3 && rankIndex <= 250) return rankIndex;
  return null;
}

function toggleFilterLogic() {
  useAndLogic = !useAndLogic;

  const btn = document.getElementById("filterLogicToggle");
  btn.textContent = useAndLogic ? "AND" : "OR";
  btn.classList.toggle("and-mode", useAndLogic);
  btn.title = useAndLogic
    ? "must match all filters"
    : "match any filter";

  filterAndSortPokemon();
}

function updateDependentMoveOptions() {
    if (!moveDropdownsLinked) return; // Do nothing if not linked

    const selectedFast = elements.filterFastMove.value;
    const selectedCharged = elements.filterChargedMove.value;

    const fastMoveSet = new Set();
    const chargedMoveSet = new Set();

    for (const id in pokemonData) {
        const p = pokemonData[id];

        const hasFast = !selectedFast || p.mon_move_1 === selectedFast;
        const hasCharged = !selectedCharged || p.mon_move_2 === selectedCharged || p.mon_move_3 === selectedCharged;

        if (hasFast && hasCharged) {
            if (p.mon_move_1) fastMoveSet.add(p.mon_move_1);
            if (p.mon_move_2) chargedMoveSet.add(p.mon_move_2);
            if (p.mon_move_3) chargedMoveSet.add(p.mon_move_3);
        }
    }

    const prevFast = selectedFast;
    const prevCharged = selectedCharged;

    elements.filterFastMove.length = 1;
    for (const move of Array.from(fastMoveSet).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterFastMove.appendChild(option);
    }

    elements.filterChargedMove.length = 1;
    for (const move of Array.from(chargedMoveSet).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterChargedMove.appendChild(option);
    }

    if (fastMoveSet.has(prevFast)) elements.filterFastMove.value = prevFast;
    if (chargedMoveSet.has(prevCharged)) elements.filterChargedMove.value = prevCharged;
}

function updateFastMoveDropdown() {
    const chargedValue = elements.filterChargedMove.value;
    if (!chargedValue) return;

    const fastMoves = new Set();
    for (const id in pokemonData) {
        const p = pokemonData[id];
        if (p.mon_move_2 === chargedValue || p.mon_move_3 === chargedValue) {
            fastMoves.add(p.mon_move_1);
        }
    }

    const prevFast = elements.filterFastMove.value;
    elements.filterFastMove.length = 1;
    for (const move of Array.from(fastMoves).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterFastMove.appendChild(option);
    }
    if (fastMoves.has(prevFast)) elements.filterFastMove.value = prevFast;
}

function updateChargedMoveDropdown() {
    const fastValue = elements.filterFastMove.value;
    if (!fastValue) return;

    const chargedMoves = new Set();
    for (const id in pokemonData) {
        const p = pokemonData[id];
        if (p.mon_move_1 === fastValue) {
            if (p.mon_move_2) chargedMoves.add(p.mon_move_2);
            if (p.mon_move_3) chargedMoves.add(p.mon_move_3);
        }
    }

    const prevCharged = elements.filterChargedMove.value;
    elements.filterChargedMove.length = 1;
    for (const move of Array.from(chargedMoves).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterChargedMove.appendChild(option);
    }
    if (chargedMoves.has(prevCharged)) elements.filterChargedMove.value = prevCharged;
}

function repopulateUnlinkedMoveDropdowns() {
    const fastMoveSet = new Set();
    const chargedMoveSet = new Set();

    for (const id in pokemonData) {
        const p = pokemonData[id];
        if (p.mon_move_1) fastMoveSet.add(p.mon_move_1);
        if (p.mon_move_2) chargedMoveSet.add(p.mon_move_2);
        if (p.mon_move_3) chargedMoveSet.add(p.mon_move_3);
    }

    const prevFast = elements.filterFastMove.value;
    const prevCharged = elements.filterChargedMove.value;

    elements.filterFastMove.length = 1;
    for (const move of Array.from(fastMoveSet).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterFastMove.appendChild(option);
    }

    elements.filterChargedMove.length = 1;
    for (const move of Array.from(chargedMoveSet).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterChargedMove.appendChild(option);
    }

    // Restore selections if still valid
    if (fastMoveSet.has(prevFast)) elements.filterFastMove.value = prevFast;
    if (chargedMoveSet.has(prevCharged)) elements.filterChargedMove.value = prevCharged;
}

function getIVColor(percent) {
    const red = [255, 0, 0];
    const green = [0, 255, 0];
    const mix = percent / 100;
    const blend = (a, b) => Math.round(a + (b - a) * Math.pow(mix,1.5));
    const r = blend(red[0], green[0]);
    const g = blend(red[1], green[1]);
    const b = blend(red[2], green[2]);
    return {
        start: `rgba(${r}, ${g}, ${b}, 0.5)`,
        end: `rgba(${r}, ${g}, ${b}, 0.275)`
    };
}

function getMoveType(moveName) {
  for (const [type, moves] of Object.entries(window.moveTypings)) {
    if (moves.includes(moveName)) return type.toLowerCase();
  }
  return "unknown";
}

function formatMoveName(move) {
  return move
    .replace(/_FAST$/, "")
    .replace(/_/g, " ")
    .toLowerCase()
    .replace(/\b\w/g, c => c.toUpperCase());
}

function createMoveBadge(moveName, monTypes = []) {
  const type = getMoveType(moveName);
  const formatted = formatMoveName(moveName);
  const stabMatch = monTypes.includes(type.toUpperCase());
  const tooltip = stabMatch ? ' title="STAB"' : "";

return `<span class="type-badge type-${type}${stabMatch ? " stab" : " faded"}"${tooltip}>${formatted}</span>`;
}

function getGenderSymbol(gender) {
    if (gender === 'MALE') return '<span class="gender-male">‚ôÇ</span>';
    if (gender === 'FEMALE') return '<span class="gender-female">‚ôÄ</span>';
    return '';
}

function calculateIVPercentage(attack, defence, stamina) {
    // IV percentage is calculated as (A + D + S) / 45 * 100
    return ((attack + defence + stamina) / 45 * 100).toFixed(2);
}

function getPokemonTypes(monNumber, monForm = null, monName = null) {
    console.log("pokeFormTypings:", window.pokeFormTypings);
console.log("1_BULBASAUR_NORMAL:", window.pokeFormTypings?.["1_BULBASAUR_NORMAL"]);

    if (monForm) {
        const cleanForm = monForm.trim().toUpperCase();
        const key = `${monNumber}_${cleanForm}`;
        // console.log("getPokemonTypes() ‚Üí checking key:", key, "‚Üí", window.pokeFormTypings[key]);
        if (window.pokeFormTypings[key]) {
            return window.pokeFormTypings[key];
        }
    } else if (monName) {
        const normalKey = `${monNumber}_${monName.trim().toUpperCase()}_NORMAL`;
        // console.log("getPokemonTypes() ‚Üí checking fallback key:", normalKey, "‚Üí", window.pokeFormTypings[normalKey]);
        if (window.pokeFormTypings[normalKey]) {
            return window.pokeFormTypings[normalKey];
        }
    }

    const types = [];
    for (const [type, numbers] of Object.entries(window.pokeFormTypings)) {
        if (numbers.includes(monNumber)) {
            types.push(type);
        }
    }
    return types;
}

// Function to build sprite url from pokemon.mon_details
function buildSpriteUrl(pokemon) {
    const pokeNumber = pokemon.mon_number.toString();
    let spriteUrl = `https://raw.githubusercontent.com/bluecereal127/BetterDex/master/pm${pokeNumber}`;

    let pm_form = pokemon.mon_form || "";
    let formPart = pm_form.substring(pm_form.indexOf('_') + 1);
    let formSuffix = (formPart === "NORMAL") ? "" : formPart;                                                       //if suffix is _NORMAL, set suffix to nothing, otherwise, substring formpart
    
    //---special cases: unown, burmy, wormadam, kyurem, genesect---//
    if(pokemon.mon_name === "UNOWN" || pokemon.mon_name === "BURMY" || pokemon.mon_name === "WORMADAM"){
        spriteUrl += `.f${pm_form}`;                                                                                // Unown, Burmy, Wormadam get full mon_form
        formSuffix = "";
    }
    if(pokemon.mon_form === "KYUREM_NORMAL" || pokemon.mon_form === "GENESECT_NORMAL"){                                           // Genesect and Kyurem get NORMAL
        spriteUrl += `.fNORMAL`;
        formSuffix = "";
    }

    if (formSuffix !== "") spriteUrl += `.f${formSuffix}`;

    let pm_costume = pokemon.mon_costume || "";
    if (pokemon.mon_costume !== "") spriteUrl += `.c${pokemon.mon_costume}`;

    if (pokemon.mon_isshiny === 'YES') {
        spriteUrl += `.s`;
    }

    spriteUrl += `.icon.png`;
    return spriteUrl;
}

// Function to create a Pok√©mon card
function createPokemonCard(id, pokemon) {
    const isShiny = pokemon.mon_isshiny === 'YES';
    const isLucky = pokemon.mon_islucky === 'YES';
    const isShadow = pokemon.mon_alignment === 'SHADOW';
    const pokeNumber = pokemon.mon_number.toString();

    // Create Sprite URL 
    let spriteUrl = buildSpriteUrl(pokemon);

    // Calculate IV percentage
    const attackIV = Number(pokemon.mon_attack) || 0;
    const defenceIV = Number(pokemon.mon_defence) || 0;
    const staminaIV = Number(pokemon.mon_stamina) || 0;
    const ivPercentage = calculateIVPercentage(attackIV, defenceIV, staminaIV);
    
    // Create card element
    const card = document.createElement('div');
    card.className = `pokemon-card ${isShiny ? 'shiny' : ''} ${isLucky ? 'lucky' : ''} ${isShadow ? 'shadow' : ''}`;
    card.dataset.id = id;

    
    
    card.dataset.id = id;
    card.onclick = () => togglePokemonSelection(id, pokemon);
    card.ondblclick = (event) => {
        event.preventDefault();
        showPokemonDetails(id, pokemon);
    };
    

    // Build card content

    const nicknameFilterSelected = document.getElementById("filterNickname").checked;
    const displayName = (nicknameFilterSelected && pokemon.mon_nickname) ? pokemon.mon_nickname : pokemon.mon_name;

    // NEW LAYOUT START
    const types = getPokemonTypes(pokemon.mon_number, pokemon.mon_form, pokemon.mon_name);
    const firstType = types[0];
    const cardBackground = window.typingBackgrounds[firstType.toUpperCase()]?.[0] || "";
    if (cardBackground) {
        const topHalf = card.querySelector('.modern-card-top');
            if (topHalf) {
                topHalf.style.backgroundImage = `url('${cardBackground}')`;
                topHalf.style.backgroundSize = "cover";
                topHalf.style.backgroundPosition = "center";
                
            }
            
    }

    const typeIconsHtml = types.map(type => {
    const upperType = type.toUpperCase();
    const iconUrl = typeIcons[upperType]?.[0] || "";
    return iconUrl
    ? `<img class="type-badge-icon" src="${iconUrl}" alt="${type}" title="${type}">`
    : '';
}).join('');


const gender = getGenderSymbol(pokemon.mon_gender);
const iv1 = Number(pokemon.mon_attack) || 0;
const iv2 = Number(pokemon.mon_defence) || 0;
const iv3 = Number(pokemon.mon_stamina) || 0;
const ivPercent = calculateIVPercentage(iv1, iv2, iv3);
const ivHash = hashIVs(iv1, iv2, iv3);
const pvpKey = (pokemon.mon_form && !pokemon.mon_form.endsWith('_NORMAL')) 
? pokemon.mon_form 
: pokemon.mon_name;

const greatList = greatLeagueRankings[pvpKey] || [];
const ultraList = ultraLeagueRankings[pvpKey] || [];

const greatRank = greatList.indexOf(ivHash);
const ultraRank = ultraList.indexOf(ivHash);

const cp = Number(pokemon.mon_cp);
let rankBadgeHtml = '';
let bestRankNum = '';
let bestRankLeague = "";
if (cp <= 1500 && (greatRank !== -1 || ultraRank !== -1)) {
    if (greatRank !== -1 && (ultraRank === -1 || greatRank < ultraRank)) {
        bestRankNum = greatRank;
        bestRankLeague = "Great League - Rank " + (greatRank+1).toString();
        const emoji = getPvpRankBadge(greatRank);
        console.log(emoji)
    if (emoji) rankBadgeHtml = `<div class="pvp-rank-badge rank-${greatRank + 1}">${emoji}</div>`;
    console.log(emoji + "pvp-rank-badge rank-${greatRank + 1}")
  } else if (ultraRank !== -1 && (greatRank === -1 || ultraRank < greatRank)) {
    bestRankNum = ultraRank;
    bestRankLeague = "Ultra League - Rank " + (ultraRank+1).toString();
    const emoji = getPvpRankBadge(ultraRank);
    console.log(emoji)
      if (emoji) rankBadgeHtml = `<div class="pvp-rank-badge rank-${ultraRank + 1}">${emoji}</div>`;
      console.log(emoji + "pvp-rank-badge rank-${ultraRank + 1}")
    } else if (greatRank === ultraRank && greatRank !== -1) {
        bestRankNum = greatRank;
        bestRankLeague = "Great League - Rank " + (greatRank+1).toString();
        const emoji = getPvpRankBadge(greatRank);
        console.log(emoji)
        if (emoji) rankBadgeHtml = `<div class="pvp-rank-badge rank-${greatRank + 1}">${emoji}</div>`;
        console.log(emoji+ "pvp-rank-badge rank-${greatRank + 1}")
    }
} else if (cp > 1500 && cp <= 2500 && ultraRank !== -1) {
    bestRankNum = ultraRank;
    bestRankLeague = "Ultra League - Rank " + (ultraRank+1).toString();

  const emoji = getPvpRankBadge(ultraRank);
  if (emoji) rankBadgeHtml = `<div class="pvp-rank-badge rank-${ultraRank + 1}">${emoji}</div>`;
  console.log(emoji + "pvp-rank-badge rank-${ultraRank + 1}")
}

// Tooltip: show nickname if it exists

let tooltip = "";
if (pokemon.mon_isshiny === "YES") {
    tooltip += "‚ú®\n";
}
if (pokemon.mon_islucky === "YES") {
    tooltip += "üçÄ\n";
}
if (pokemon.mon_name){
    if(pokemon.mon_form && !pokemon.mon_form.endsWith("_NORMAL")) {
        tooltip += "Species: " + pokemon.mon_form.toString();
    } else{
    tooltip += "Species: " + pokemon.mon_name.toString();
    }
}
if (pokemon.mon_nickname) {
    tooltip += "\n Nickname: " + pokemon.mon_nickname.toString();
}
if (pokemon.mon_costume) {
    tooltip += "\n Costume: " +pokemon.mon_costume.toString();
}
if (pokemon.mon_alignment === 'SHADOW'){
    tooltip += "\n Alignment: Shadow";
} else if (pokemon.mon_alignment === 'PURIFIED'){
    tooltip += "\n Alignment: Purified";
}
if (rankBadgeHtml){
    tooltip += "\n---PVP---\n " + bestRankLeague;
}

if (tooltip) {
    card.title = tooltip;
}



// const isRankedAtAll = pvpRankings[pvpKey]?.includes(ivHash);


// Generate moveBadgeIds (type icons for moves)
const move1Type = getMoveType(pokemon.mon_move_1);
const move2Type = getMoveType(pokemon.mon_move_2);
const move3Type = getMoveType(pokemon.mon_move_3);

const moveBadgeId1 = typeBadgeNumbers[move1Type?.toUpperCase()] || "";
const moveBadgeId2 = typeBadgeNumbers[move2Type?.toUpperCase()] || "";
const moveBadgeId3 = typeBadgeNumbers[move3Type?.toUpperCase()] || "";

const moveIcon1 = typeIcons[move1Type?.toUpperCase()]?.[0]
  ? `<img class='type-badge-icon' src='${typeIcons[move1Type.toUpperCase()][0]}' alt='${move1Type}' title='${move1Type}'>`
  : "";

const moveIcon2 = typeIcons[move2Type?.toUpperCase()]?.[0]
  ? `<img class='type-badge-icon' src='${typeIcons[move2Type.toUpperCase()][0]}' alt='${move2Type}' title='${move2Type}'>`
  : "";

const moveIcon3 = typeIcons[move3Type?.toUpperCase()]?.[0]
  ? `<img class='type-badge-icon' src='${typeIcons[move3Type.toUpperCase()][0]}' alt='${move3Type}' title='${move3Type}'>`
  : "";

card.innerHTML = `
<div class="modern-card">
    ${isShiny ? `<img class="shiny-icon" src="https://raw.githubusercontent.com/bluecereal127/pogo_assets/master/Images/Pokedex/ic_shiny.png" alt="Shiny">` : ""}
    ${rankBadgeHtml ? `<div class="pvp-rank-badge" title="Rank "${bestRankNum+1}"">${rankBadgeHtml}</div>` : ""}
  <div class="modern-card-top">
    
    <!-- Everything in the top half -->
    <div class="modern-header">
      <div class="modern-cp">cp ${pokemon.mon_cp}</div>
    </div>
    <div class="modern-image">
      <img src="${spriteUrl}" class="pokemon-img" alt="${displayName}">
    </div>
  </div>

  <div class="modern-card-bottom">
    <!-- Everything in the bottom half -->
    <div class="modern-name" style="font-size:12px">${displayName} ${gender}</div>

    <div class="modern-info-row">
        <div class="modern-types type-icon-row">${typeIconsHtml}</div>
    </div>

    <div class="modern-moves">
    <span class="move-icon-wrap">${moveIcon1}${createMoveBadge(pokemon.mon_move_1, types)}</span>
    <span class="move-icon-wrap">${moveIcon2}${createMoveBadge(pokemon.mon_move_2, types)}</span>
    ${pokemon.mon_move_3 ? `
        <span class="move-icon-wrap">${moveIcon3}${createMoveBadge(pokemon.mon_move_3, types)}</span>
    ` : `
        <div style="height: 24px;"></div>
    `}
    </div>


    <div class="modern-ivs">
      <div class="iv-value">${iv1}</div>
      <div class="iv-value">${iv2}</div>
      <div class="iv-value">${iv3}</div>
    </div>

    <div class="iv-labels">
      <div class="iv-label">‚öîÔ∏è</div>
      <div class="iv-label">üõ°Ô∏è</div>
      <div class="iv-label">‚ù§Ô∏è</div>
    </div>
  </div>
</div>
`;
    const encasing= card.querySelector('.modern-card');
    if (cardBackground && encasing) {
    encasing.style.backgroundImage = `url('${cardBackground}')`;
    encasing.style.backgroundSize = "cover";
    encasing.style.backgroundPosition = "center";
    }


    //console.log(`Moves for ${pokemon.mon_name}:`, moveBadges); // üëà Add this


    // Highlight selection
    if (selectedPokemonIds.has(id)) {
        card.classList.add('selected');
    }

    // Style IV background
    const percent = parseFloat(ivPercentage);
    const color = getIVColor(percent);
    card.style.setProperty('--iv-gradient-start', color.start);
    card.style.setProperty('--iv-gradient-end', color.end);
    card.dataset.ivPercent = ivPercentage;

    return card;
}


// Function to toggle Pokemon selection
function togglePokemonSelection(id, pokemon) {
    if (selectedPokemonIds.has(id)) {
        selectedPokemonIds.delete(id);
        document.querySelector(`.pokemon-card[data-id="${id}"]`).classList.remove('selected');
    } else {
        selectedPokemonIds.add(id);
        document.querySelector(`.pokemon-card[data-id="${id}"]`).classList.add('selected');
    }
    
    elements.selectedCount.textContent = `${selectedPokemonIds.size} selected`;
    updateStats();
}

// Function to build sprite url from pokemon.mon_details
function buildSpriteUrl(pokemon) {
    const pokeNumber = pokemon.mon_number.toString();
    let spriteUrl = `https://raw.githubusercontent.com/bluecereal127/BetterDex/master/pm${pokeNumber}`;

    let pm_form = pokemon.mon_form || "";
    let formPart = pm_form.substring(pm_form.indexOf('_') + 1);
    let formSuffix = (formPart === "NORMAL") ? "" : formPart;                                                       //if suffix is _NORMAL, set suffix to nothing, otherwise, substring formpart
    
    //---special cases: unown, burmy, wormadam, kyurem, genesect---//
    if(pokemon.mon_name === "UNOWN" || pokemon.mon_name === "BURMY" || pokemon.mon_name === "WORMADAM"){
        spriteUrl += `.f${pm_form}`;                                                                                // Unown, Burmy, Wormadam get full mon_form
        formSuffix = "";
    }
    if(pokemon.mon_form === "KYUREM_NORMAL" || pokemon.mon_form === "GENESECT_NORMAL"){                             // Genesect and Kyurem get NORMAL
        spriteUrl += `.fNORMAL`;
        formSuffix = "";
    }
    if (formSuffix !== "") spriteUrl += `.f${formSuffix}`;
    
    let pm_costume = pokemon.mon_costume || "";
    if (pokemon.mon_costume && pokemon.mon_costume !== "") spriteUrl += `.c${pokemon.mon_costume}`;

    if (pokemon.mon_isshiny === 'YES') {
        spriteUrl += `.s`;
    }

    spriteUrl += `.icon.png`;
    return spriteUrl;
}
// Function to show Pokemon details in modal
function showPokemonDetails(id, pokemon) {
    const isShiny = pokemon.mon_isshiny === 'YES';
    const isLucky = pokemon.mon_islucky === 'YES';
    const isShadow = pokemon.mon_alignment === 'SHADOW';
    const isPurified = pokemon.mon_alignment === 'PURIFIED';
    const pokeNumber = pokemon.mon_number.toString();
    
    const winRate = pokemon.mon_pvp_stats ? (pokemon.mon_pvp_stats.pvp_won/pokemon.mon_pvp_stats.pvp_total*100).toFixed(2):undefined;

    let spriteUrl = buildSpriteUrl(pokemon);

    // Calculate IV percentage
    const attackIV = Number(pokemon.mon_attack) || 0;
    const defenceIV = Number(pokemon.mon_defence) || 0;
    const staminaIV = Number(pokemon.mon_stamina) || 0;
    const ivPercentage = calculateIVPercentage(attackIV, defenceIV, staminaIV);

    // Get typings
    const types = getPokemonTypes(pokemon.mon_number, pokemon.mon_form);
    const typeHtml = types.map(type => `<span class="type-badge type-${type.toLowerCase()}">${type}</span>`).join('');


    masterUrl = spriteUrl;

    // Build modal content
    elements.modalDetails.innerHTML = `
        <div class="detail-pokemon-sprite">
            <img src="${spriteUrl}" alt="${pokemon.mon_name}" class="sprite" onerror="this.src='https://raw.githubusercontent.com/bluecereal127/BetterDex/master/pm${pokeNumber}.icon.png'">
            <div class="pokemon-number">${pokemon.mon_number}${pokemon.mon_nickname ? `<strong>${pokemon.mon_nickname}</strong>` : `${pokemon.mon_form && !pokemon.mon_form.endsWith('_NORMAL') ? `${pokemon.mon_form.replace((pokemon.mon_name)+'_', ' ')}` : ''}`}</div>
        </div>

        <div class="detail-pokemon-info">
            <div class="detail-section">
                <h3>Basic Information</h3>
                <table class="detail-table">
                    <tr>
                        <th>CP</th>
                        <td>${pokemon.mon_cp}</td>
                    </tr>
                    <tr>
                        <th>HP</th>
                        <td>${pokemon.mon_stamina}</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td><div class="pokemon-types">${typeHtml}</div></td>
                    </tr>
                    <tr>
                        <th>Special Attributes</th>
                        <td>
                            ${isShiny ? '<span class="badge shiny-badge">Shiny</span>' : ''}
                            ${isShadow ? '<span class="badge shadow-badge">Shadow</span>' : ''}
                            ${isPurified ? '<span class="badge">Purified</span>' : ''}
                            ${isLucky ? '<span class="badge lucky-badge">Lucky</span>' : ''}
                        </td>
                    </tr>
                    <tr>
                        <th>Caught Date</th>
                        <td>${pokemon.mon_timestamp || 'Unknown'}</td>
                    </tr>
                </table>
            </div>

            <div class="detail-section">
                <h3>Individual Values (IV)</h3>
                <div class="detail-stats">
                    <div class="detail-stat-box">
                        <div>Attack</div>
                        <div style="font-weight: bold;">${attackIV}/15</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar stat-bar-attack" style="width: ${(attackIV / 15) * 100}%"></div>
                        </div>
                    </div>
                    <div class="detail-stat-box">
                        <div>Defense</div>
                        <div style="font-weight: bold;">${defenceIV}/15</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar stat-bar-defence" style="width: ${(defenceIV / 15) * 100}%"></div>
                        </div>
                    </div>
                    <div class="detail-stat-box">
                        <div>Stamina</div>
                        <div style="font-weight: bold;">${staminaIV}/15</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar stat-bar-stamina" style="width: ${(staminaIV / 15) * 100}%"></div>
                        </div>
                    </div>
                    <div class="detail-stat-box">
                        <div>Total IV</div>
                        <div style="font-weight: bold;">${ivPercentage}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${ivPercentage}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Moves</h3>
                <div class="detail-moves">
                    <div class="detail-move">
                        <div style="font-size: 12px; color: #777;">Fast Move</div>
                        <div style="font-weight: bold;">${formatMoveName(pokemon.mon_move_1)}</div>
                        <div style="font-size: 12px;">Type: ${pokemon.mon_move_1_type || 'Unknown'}</div>
                    </div>
                    <div class="detail-move">
                        <div style="font-size: 12px; color: #777;">Charged Move</div>
                        <div style="font-weight: bold;">${formatMoveName(pokemon.mon_move_2)}</div>
                        <div style="font-size: 12px;">Type: ${pokemon.mon_move_2_type || 'Unknown'}</div>
                    </div>
                    ${pokemon.mon_move_3 ? `
                    <div class="detail-move">
                        <div style="font-size: 12px; color: #777;">Charged Move 2</div>
                        <div style="font-weight: bold;">${formatMoveName(pokemon.mon_move_3)}</div>
                        <div style="font-size: 12px;">Type: ${pokemon.mon_move_3_type || 'Unknown'}</div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <div class="detail-section">
                <h3>Additional Details</h3>
                <table class="detail-table">
                    
                    ${pokemon.mon_pvp_stats ? `
                    <tr>
                        <th>PVP battles</th>
                        <td>${pokemon.mon_pvp_stats.pvp_total}</td>
                    </tr>
                    <tr>
                        <th>PVP wins</th>
                        <td>${pokemon.mon_pvp_stats.pvp_won}</td>
                    </tr>
                        <tr>

                    <tr>
                        <th>Win Rate</th>
                        <td>${winRate}%</td>
                    </tr>
                        <tr>
                            ` : ''}
                    <tr>
                        <th>Height</th>
                        <td>${pokemon.mon_height} m</td>
                    </tr>
                    <tr>
                        <th>Weight</th>
                        <td>${pokemon.mon_weight} kg</td>
                    </tr>

                        <th>Form</th>
                        <td>${pokemon.mon_form ? pokemon.mon_form.replace('_', ' ') : 'Normal'}</td>
                    </tr>
                    <tr>
                        <th>Costume</th>
                        <td>${pokemon.mon_costume ? pokemon.mon_costume.replace('_', ' ') : 'None'}</td>
                    </tr>
                </table>
            </div>
        </div>
    `;

    // Show modal
    elements.pokemonModal.classList.remove('hidden');
}

// Place here with other helper functions
function hashIVs(attack, defense, stamina) {
  return (attack << 8) | (defense << 4) | stamina;
}


function isStabType(moveType, monTypes) {
  return monTypes.includes(moveType);
}

function getPokemonRegion(pokemon) {
  const form = pokemon.mon_form ? pokemon.mon_form.trim().toUpperCase() : "";

  // Check form overrides
  for (const [region, forms] of Object.entries(window.formRegionOverrides)) {
    if (forms.includes(form)) return region;
  }

  const num = Number(pokemon.mon_number);

  if (num >= 1 && num <= 151) return "Kanto";
  if (num >= 152 && num <= 251) return "Johto";
  if (num >= 252 && num <= 386) return "Hoenn";
  if (num >= 387 && num <= 493) return "Sinnoh";
  if (num >= 494 && num <= 649) return "Unova";
  if (num >= 650 && num <= 721) return "Kalos";
  if (num >= 722 && num <= 809) return "Alola";
  if (num >= 810 && num <= 898) return "Galar";
  if (num >= 899 && num <= 905) return "Hisui";
  if (num >= 906 && num <= 1025) return "Paldea";
  if (num >= 807 && num <= 808) return "Undefined";

  return "Unknown";
}


const GEN_TO_REGION = {
  "1": "Kanto",
  "2": "Johto",
  "3": "Hoenn",
  "4": "Sinnoh",
  "5": "Unova",
  "6": "Kalos",
  "7": "Alola",
  "8": "Galar",
  "9": "Paldea"
};

// Master Function to filter and sort Pokemon
function filterAndSortPokemon() {
    filteredPokemonIds = [];

    const searchText = elements.searchInput.value.toLowerCase();
    let force3MoveFilter = false;

    if (searchText.includes("3move") || searchText.includes("3moves")) {
        force3MoveFilter = true;
    }
    const sortBy = elements.sortBy.value;
    const filterStatus = elements.filterStatus.value;
    const filterFastMove = elements.filterFastMove.value;
    const filterChargedMove = elements.filterChargedMove.value;
    const filterGender = elements.filterGender.value;
    const filterForm = elements.filterForm.value;
    const filterCostume = elements.filterCostume.value;
    const regionFilter = elements.filterRegion.value;

    const activeSpecialFilters = [];
    if (elements.filterShiny.checked) activeSpecialFilters.push('shiny');
    if (elements.filterLucky.checked) activeSpecialFilters.push('lucky');
    if (elements.filterShadow.checked) activeSpecialFilters.push('shadow');
    if (elements.filterPurified.checked) activeSpecialFilters.push('purified');
    if (elements.filterHundo.checked) activeSpecialFilters.push('hundo');
    if (elements.filterNundo.checked) activeSpecialFilters.push('nundo');
    if (elements.filterNickname.checked) activeSpecialFilters.push('nickname');

    // Advanced filters
    const cpMin = elements.cpMin.value !== '' ? parseInt(elements.cpMin.value) : 0;
    const cpMax = elements.cpMax.value !== '' ? parseInt(elements.cpMax.value) : Infinity;
    const attackMin = elements.attackMin.value !== '' ? parseInt(elements.attackMin.value) : 0;
    const attackMax = elements.attackMax.value !== '' ? parseInt(elements.attackMax.value) : 15;
    const defenceMin = elements.defenceMin.value !== '' ? parseInt(elements.defenceMin.value) : 0;
    const defenceMax = elements.defenceMax.value !== '' ? parseInt(elements.defenceMax.value) : 15;
    const staminaMin = elements.staminaMin.value !== '' ? parseInt(elements.staminaMin.value) : 0;
    const staminaMax = elements.staminaMax.value !== '' ? parseInt(elements.staminaMax.value) : 15;

    // Parse search terms
    let searchTerms = [];
    if (searchText) {
        const andGroups = searchText.split('&').map(group => group.trim());
        searchTerms = andGroups.map(group =>
            group.split(/[,|]/)
                .map(term => term.trim())
                .filter(term => term && term !== "3move" && term !== "3moves")
        ).filter(group => group.length > 0);
    }


    for (const id in pokemonData) {
        const pokemon = pokemonData[id];

        // All Forms toggle button
        // If either All Forms or All Costumes is active, show Pok√©mon matching either
        if (window.filterAltFormsOnlyState || window.filterCostumedOnlyState) {
            const isAltForm = window.filterAltFormsOnlyState && pokemon.mon_form && !pokemon.mon_form.endsWith("_NORMAL");
            const isCostumed = window.filterCostumedOnlyState && pokemon.mon_costume && pokemon.mon_costume !== "";

            if (!isAltForm && !isCostumed) continue;
        }


        // Type filter (union of selected types)

        if (selectedTypes.size > 0) {
            const types = getPokemonTypes(pokemon.mon_number, pokemon.mon_form).map(t => t.toLowerCase());
            const selected = Array.from(selectedTypes).map(s => s.toLowerCase());
            const matches = selected.filter(sel => types.includes(sel));
            const pass = useAndLogic ? matches.length === selected.length : matches.length > 0;
            if (!pass) continue;
            }


            
            // // Custom filter: "3move" or "3moves"
            // if (searchText === "3move" || searchText === "3moves" || searchText === "@3") {
            //     if (!pokemon.mon_move_3 || pokemon.mon_move_3 === "") continue;
            // }

            if (force3MoveFilter && (!pokemon.mon_move_3 || pokemon.mon_move_3 === "")) {
                continue;
            }

            
            // Search term filtering
            
        let matchesSearch = true;
        if (searchTerms.length > 0) {
            matchesSearch = searchTerms.every(orGroup => {
                let hasPositiveMatch = false;
                for (const termRaw of orGroup) {
                    const isNegated = termRaw.startsWith('!');
                    const term = isNegated ? termRaw.slice(1) : termRaw;
                    let matched = false;

                    const genMatch = term.toLowerCase().match(/^gen(\d)$/);
                    if (genMatch) {
                        const targetRegion = GEN_TO_REGION[genMatch[1]];
                        matched = getPokemonRegion(pokemon).toLowerCase() === targetRegion.toLowerCase();
                    } 
                    else if (Object.values(GEN_TO_REGION).map(r => r.toLowerCase()).includes(term.toLowerCase())) {
                        matched = getPokemonRegion(pokemon).toLowerCase() === term.toLowerCase();
                    }

                    else if (/^\d+(-\d+)?$/.test(term)) {
                        if (term.includes('-')) {
                            const [min, max] = term.split('-').map(Number);
                            matched = pokemon.mon_number >= min && pokemon.mon_number <= max;
                        } else {
                            matched = pokemon.mon_number === parseInt(term);
                        }
                    } 
                        else if (window.specialSearchOptions[term.toUpperCase()]) {
                            matched = window.specialSearchOptions[term.toUpperCase()].includes(pokemon.mon_number);
                        }else if (term === "3move" || term === "3moves" || term === "@3") {
                        matched = Boolean(pokemon.mon_move_3 && pokemon.mon_move_3 !== "");
                        }
                        else {
                            const monName = pokemon.mon_name || "";
                            const monNickname = pokemon.mon_nickname || "";

                            const termLower = term.toLowerCase();
                            const monNameLower = monName.toLowerCase();
                            const monNicknameLower = monNickname.toLowerCase();

                            const isQuoted = term.startsWith('"') && term.endsWith('"');
                            const exactMatch = termLower.replace(/^"|"$/g, ""); // remove quotes if present

                            // If quoted OR comma-separated (more than 1 item in orGroup), do exact match
                            if (isQuoted || orGroup.length > 1) {
                                matched = monNameLower === exactMatch || monNicknameLower === exactMatch;
                            } else {
                                // Default substring match
                                matched = monNameLower.includes(termLower) || monNicknameLower.includes(termLower);
                            }
                        }


                    if (isNegated && matched) return false;
                    if (!isNegated && matched) hasPositiveMatch = true;
                }
                return hasPositiveMatch || orGroup.every(term => term.startsWith('!'));
            });

            if (!matchesSearch) continue;
        }

        // Status dropdown
        if (filterStatus === 'shiny' && pokemon.mon_isshiny !== 'YES') continue;
        if (filterStatus === 'shadow' && pokemon.mon_alignment !== 'SHADOW') continue;
        if (filterStatus === 'lucky' && pokemon.mon_islucky !== 'YES') continue;

        // Special checkboxes

        if (activeSpecialFilters.length > 0) {
            const totalIV = (parseInt(pokemon.mon_attack) || 0) + (parseInt(pokemon.mon_defence) || 0) + (parseInt(pokemon.mon_stamina) || 0);

            const matches = {
                shiny: pokemon.mon_isshiny === 'YES',
                lucky: pokemon.mon_islucky === 'YES',
                shadow: pokemon.mon_alignment === 'SHADOW',
                purified: pokemon.mon_alignment === 'PURIFIED',
                hundo: totalIV === 45,
                nundo: totalIV === 0,
                nickname: Boolean(pokemon.mon_nickname),
            };

            const matchedKeys = activeSpecialFilters.filter(f => matches[f]);
            const pass = useAndLogic ? matchedKeys.length === activeSpecialFilters.length : matchedKeys.length > 0;

            if (!pass) continue;
            }


        // if (activeSpecialFilters.length > 0) {
        //     const totalIV = (parseInt(pokemon.mon_attack) || 0) + (parseInt(pokemon.mon_defence) || 0) + (parseInt(pokemon.mon_stamina) || 0);
        //     const matchesAny =
        //         (activeSpecialFilters.includes('shiny') && pokemon.mon_isshiny === 'YES') ||
        //         (activeSpecialFilters.includes('lucky') && pokemon.mon_islucky === 'YES') ||
        //         (activeSpecialFilters.includes('shadow') && pokemon.mon_alignment === 'SHADOW') ||
        //         (activeSpecialFilters.includes('purified') && pokemon.mon_alignment === 'PURIFIED') ||
        //         (activeSpecialFilters.includes('hundo') && totalIV === 45) ||
        //         (activeSpecialFilters.includes('nundo') && totalIV === 0) ||
        //         (activeSpecialFilters.includes('nickname') && pokemon.mon_nickname);

        //     if (!matchesAny) continue;
        // }

        // Move filter
        // Move filters (Fast and Charged)
        if (filterFastMove && pokemon.mon_move_1 !== filterFastMove) {
            continue;
        }

        if (filterChargedMove &&
            pokemon.mon_move_2 !== filterChargedMove &&
            pokemon.mon_move_3 !== filterChargedMove) {
            continue;
        }


        // Gender, Form, Costume
        if (filterGender && pokemon.mon_gender !== filterGender) continue;
        if (filterForm && filterForm !== "" && filterForm !== "ALL" && pokemon.mon_form !== filterForm) continue;
        // console.log(`${pokemon.mon_name}_${pokemon.mon_form} ‚Üí Region: ${getPokemonRegion(pokemon)}`);
        if (filterCostume && pokemon.mon_costume !== filterCostume) continue;

        // Region
        if (regionFilter && getPokemonRegion(pokemon).toLowerCase() !== regionFilter.toLowerCase()) continue;

        // CP range
        const cp = parseInt(pokemon.mon_cp);
        if (cp < cpMin || cp > cpMax) continue;

        // IV ranges
        const attackIV = Number(pokemon.mon_attack) || 0;
        const defenceIV = Number(pokemon.mon_defence) || 0;
        const staminaIV = Number(pokemon.mon_stamina) || 0;
        if (attackIV < attackMin || attackIV > attackMax) continue;
        if (defenceIV < defenceMin || defenceIV > defenceMax) continue;
        if (staminaIV < staminaMin || staminaIV > staminaMax) continue;

        filteredPokemonIds.push(id);
    }

    // Sorting
    filteredPokemonIds.sort((a, b) => {
        const pokemonA = pokemonData[a];
        const pokemonB = pokemonData[b];

        switch (sortBy) {
            case 'number':  return parseInt(pokemonA.mon_number) - parseInt(pokemonB.mon_number);
            case 'cp':      return parseInt(pokemonB.mon_cp) - parseInt(pokemonA.mon_cp);
            case 'name':    return pokemonA.mon_name.localeCompare(pokemonB.mon_name);
            case 'attack':  return parseInt(pokemonB.mon_attack) - parseInt(pokemonA.mon_attack);
            case 'defence': return parseInt(pokemonB.mon_defence) - parseInt(pokemonA.mon_defence);
            case 'stamina': return parseInt(pokemonB.mon_stamina) - parseInt(pokemonA.mon_stamina);
            default: return 0;
        }
    });

    displayPokemon(true);
    updateStats();
}


// Function to display Pokemon
function displayPokemon(reset = false) {
    if (reset) {
        elements.pokemonGrid.innerHTML = '';
        currentlyDisplayed = 0;
    }
    
    const remaining = filteredPokemonIds.length - currentlyDisplayed;
    const toDisplay = Math.min(displayLimit, remaining);
    
    const displayIds = filteredPokemonIds.slice(currentlyDisplayed, currentlyDisplayed + toDisplay);
    
    for (const id of displayIds) {
        const pokemon = pokemonData[id];
        const card = createPokemonCard(id, pokemon);
        elements.pokemonGrid.appendChild(card);
    }
    
    currentlyDisplayed += toDisplay;
    elements.loadMoreBtn.classList.toggle('hidden', currentlyDisplayed >= filteredPokemonIds.length);
    
    if (filteredPokemonIds.length === 0) {
        elements.pokemonGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: #777;">No Pok√©mon found matching your filters.</div>';
    }
}

// Function to populate dropdowns
function populateDropdowns() {
    // Clear old options
    while (elements.filterFastMove.options.length > 1) {
        elements.filterFastMove.remove(1);
    }
    while (elements.filterChargedMove.options.length > 1) {
        elements.filterChargedMove.remove(1);
    }

    // Collect moves
    const fastMoveSet = new Set();
    const chargedMoveSet = new Set();

    for (const id in pokemonData) {
        const p = pokemonData[id];
        if (p.mon_move_1) fastMoveSet.add(p.mon_move_1);
        if (p.mon_move_2) chargedMoveSet.add(p.mon_move_2);
        if (p.mon_move_3) chargedMoveSet.add(p.mon_move_3);
    }

    // Populate Fast Moves
    for (const move of Array.from(fastMoveSet).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterFastMove.appendChild(option);
    }

    // Populate Charged Moves
    for (const move of Array.from(chargedMoveSet).sort()) {
        const option = document.createElement('option');
        option.value = move;
        option.textContent = formatMoveName(move);
        elements.filterChargedMove.appendChild(option);
    }

    
    while (elements.filterForm.options.length > 1) {
        elements.filterForm.remove(1);
    }
    
    while (elements.filterCostume.options.length > 1) {
        elements.filterCostume.remove(1);
    }
    
    // Add form options
    for (const form of Array.from(allForms).sort()) {
        if (form.endsWith('_NORMAL') || form.endsWith('_STANDARD')) continue;
        const option = document.createElement('option');
        option.value = form;
        option.textContent = form ? form.replace('_', ' ') : 'Normal';
        elements.filterForm.appendChild(option);
    }
    
    // Add costume options
    for (const costume of Array.from(allCostumes).sort()) {
        if (!costume) continue;
        const option = document.createElement('option');
        option.value = costume;
        option.textContent = costume.replace('_', ' ');
        elements.filterCostume.appendChild(option);
    }
    updateDependentMoveOptions();
}

// Function to update stats
function updateStats() {
    const useSelected = selectedPokemonIds.size > 0;
    const isFiltered = !useSelected && filteredPokemonIds.length < Object.keys(pokemonData).length;
    const statsContainer = document.getElementById("statsContainer");
    statsContainer.classList.remove("selected-mode", "filtered-mode");

    if (useSelected) {
        statsContainer.classList.add("selected-mode");
    } else if (isFiltered) {
        statsContainer.classList.add("filtered-mode");
    }

    const targetIds = useSelected ? Array.from(selectedPokemonIds) : filteredPokemonIds;
    const labelText = useSelected ? ' (Selected)' : '';


    const suffixIds = [
      "totalStatLabelSuffix",
      "uniqueStatLabelSuffix",
      "shinyStatLabelSuffix",
      "shadowStatLabelSuffix",
      "luckyStatLabelSuffix",
      "cpStatLabelSuffix",
      "ivStatLabelSuffix"
    ];

    suffixIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = labelText;
    });

    if (!targetIds || targetIds.length === 0) {
        elements.totalPokemon.textContent = 0;
        elements.uniquePokemon.textContent = 0;
        elements.shinyCount.textContent = 0;
        elements.shadowCount.textContent = 0;
        elements.luckyCount.textContent = 0;
        elements.avgCp.textContent = 0;
        elements.avgIv.textContent = '0%';
        return;
    }

    const uniqueSpecies = new Set();
    let shinyCount = 0;
    let shadowCount = 0;
    let luckyCount = 0;
    let totalCp = 0;
    let totalIv = 0;

    for (const id of targetIds) {
        const pokemon = pokemonData[id];
        if (!pokemon) continue;

        uniqueSpecies.add(pokemon.mon_number);
        if (pokemon.mon_isshiny === 'YES') shinyCount++;
        if (pokemon.mon_alignment === 'SHADOW') shadowCount++;
        if (pokemon.mon_islucky === 'YES') luckyCount++;

        totalCp += parseInt(pokemon.mon_cp) || 0;

        const attackIV = Number(pokemon.mon_attack) || 0;
        const defenceIV = Number(pokemon.mon_defence) || 0;
        const staminaIV = Number(pokemon.mon_stamina) || 0;
        totalIv += (attackIV + defenceIV + staminaIV) / 45;
    }

    elements.totalPokemon.textContent = targetIds.length;
    elements.uniquePokemon.textContent = uniqueSpecies.size;
    elements.shinyCount.textContent = shinyCount;
    elements.shadowCount.textContent = shadowCount;
    elements.luckyCount.textContent = luckyCount;
    elements.avgCp.textContent = Math.round(totalCp / targetIds.length);
    elements.avgIv.textContent = (totalIv / targetIds.length * 100).toFixed(2) + '%';
}


// Function to export selected pokemon to JSON
function exportSelectedPokemon() {
    if (selectedPokemonIds.size === 0) {
        alert('No Pok√©mon selected. Please select at least one Pok√©mon to export.');
        return;
    }
    
    const selectedPokemon = {};
    for (const id of selectedPokemonIds) {
        selectedPokemon[id] = pokemonData[id];
    }
    
    const jsonString = JSON.stringify(selectedPokemon, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'selected_pokemon.json';
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 100);
}

// Function to load sample data
function loadSampleData() {
    const sampleData = {
  "9632908670737782471": {
    "mon_isshiny": "NO",
    "mon_weight": 87.94282531738281,
    "mon_islucky": "NO",
    "mon_move_1": "ROLLOUT_FAST",
    "mon_move_3": "HYDRO_CANNON",
    "mon_height": 1.4901500940322876,
    "mon_gender": "MALE",
    "mon_form": "BLASTOISE_NORMAL",
    "mon_nickname": "G1",
    "mon_stamina": 15,
    "mon_attack": 1,
    "mon_name": "BLASTOISE",
    "mon_move_2": "ICE_BEAM",
    "mon_cp": 1498,
    "mon_number": 9,
    "mon_defence": 15
  },
  "12533949252660279085": {
    "mon_isshiny": "NO",
    "mon_weight": 82.90076446533203,
    "mon_islucky": "NO",
    "mon_move_1": "ROLLOUT_FAST",
    "mon_move_3": "ICE_BEAM",
    "mon_height": 1.5313935279846191,
    "mon_gender": "MALE",
    "mon_form": "BLASTOISE_NORMAL",
    "mon_nickname": "G15/U22",
    "mon_stamina": 15,
    "mon_attack": 1,
    "mon_name": "BLASTOISE",
    "mon_alignment": "SHADOW",
    "mon_move_2": "SKULL_BASH",
    "mon_cp": 1491,
    "mon_number": 9,
    "mon_defence": 13
  },
  "4721233759286587858": {
    "mon_isshiny": "YES",
    "mon_islucky": "NO",
    "mon_weight": 133.12974548339844,
    "mon_move_1": "BITE_FAST",
    "mon_costume": "SUMMER_2018",
    "mon_height": 1.8652832508087158,
    "mon_gender": "MALE",
    "mon_form": "BLASTOISE_NORMAL",
    "mon_stamina": 11,
    "mon_attack": 15,
    "mon_name": "BLASTOISE",
    "mon_move_2": "HYDRO_CANNON",
    "mon_cp": 1039,
    "mon_number": 9,
    "mon_defence": 12
  },
  "7342167455917183831": {
    "mon_isshiny": "NO",
    "mon_weight": 45.615379333496094,
    "mon_islucky": "NO",
    "mon_move_1": "AIR_SLASH_FAST",
    "mon_npc_stats": {
      "npc_total": 46,
      "npc_won": 43
    },
    "mon_move_3": "AERIAL_ACE",
    "mon_height": 1.6114568710327148,
    "mon_pvp_stats": {
      "pvp_won": 0,
      "pvp_total": 1
    },
    "mon_gender": "FEMALE",
    "mon_nickname": "U8",
    "mon_stamina": 15,
    "mon_attack": 14,
    "mon_name": "PIDGEOT",
    "mon_alignment": "SHADOW",
    "mon_move_2": "FRUSTRATION",
    "mon_cp": 2387,
    "mon_number": 18,
    "mon_defence": 14,
    "mon_weather_boost": "PARTLY_CLOUDY"
  }
};
    
    loadPokemonData(sampleData);
}

// Function to process uploaded JSON file
function handleFileUpload(event) {
    const fileInput = event.target;
    const file = fileInput.files[0];
    
    if (!file) {
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            loadPokemonData(data);
        } catch (error) {
            alert('Error parsing JSON file: ' + error.message);
        }
    };
    
    reader.readAsText(file);
    fileInput.value = '';
}

// Function to load Pokemon data
function loadPokemonData(data) {
    pokemonData = data;
    selectedPokemonIds.clear();
    elements.selectedCount.textContent = '0 selected';
    
    allMoves = new Set();
    allForms = new Set();
    allCostumes = new Set();
    
    for (const id in pokemonData) {
        const pokemon = pokemonData[id];
        
        if (pokemon.mon_move_1) allMoves.add(pokemon.mon_move_1);
        if (pokemon.mon_move_2) allMoves.add(pokemon.mon_move_2);
        if (pokemon.mon_move_3) allMoves.add(pokemon.mon_move_3);
        if (pokemon.mon_form) allForms.add(pokemon.mon_form);
        if (pokemon.mon_costume) allCostumes.add(pokemon.mon_costume);
    }
    
    populateDropdowns();
    updateStats();
    filterAndSortPokemon();
}

// Function to select all visible Pokemon
function selectAllVisible() {
    for (const id of filteredPokemonIds) {
        selectedPokemonIds.add(id);
        const card = document.querySelector(`.pokemon-card[data-id="${id}"]`);
        if (card) {
            card.classList.add('selected');
        }
    }
    
    elements.selectedCount.textContent = `${selectedPokemonIds.size} selected`;
}

// Function to deselect all Pokemon
function deselectAll() {
    selectedPokemonIds.clear();
    const selectedCards = document.querySelectorAll('.pokemon-card.selected');
    for (const card of selectedCards) {
        card.classList.remove('selected');
    }
    
    elements.selectedCount.textContent = '0 selected';
}

// Event listeners
function setupEventListeners() {
    // Filter changes
    elements.searchInput.addEventListener('input', filterAndSortPokemon);
    elements.sortBy.addEventListener('change', filterAndSortPokemon);
    elements.filterStatus.addEventListener('change', filterAndSortPokemon);
    elements.filterGender.addEventListener('change', filterAndSortPokemon);
    elements.filterForm.addEventListener('change', filterAndSortPokemon);
    elements.filterCostume.addEventListener('change', filterAndSortPokemon);
    elements.filterRegion.addEventListener('change', filterAndSortPokemon);
    
    // Move filters
    elements.filterFastMove.addEventListener('change', filterAndSortPokemon);
    elements.filterChargedMove.addEventListener('change', filterAndSortPokemon);
    elements.filterFastMove.addEventListener('change', () => {
        updateDependentMoveOptions();
        filterAndSortPokemon();
    });

    elements.filterChargedMove.addEventListener('change', () => {
        updateDependentMoveOptions();
        filterAndSortPokemon();
    });

    document.getElementById('toggleMoveLink').addEventListener('click', () => {
        moveDropdownsLinked = !moveDropdownsLinked;

        const toggleBtn = document.getElementById('toggleMoveLink');
        toggleBtn.textContent = moveDropdownsLinked ? 'üîÉ' : 'üîÄ';

        if (moveDropdownsLinked) {
            // Re-filter based on current selection
            updateDependentMoveOptions();
        } else {
            // Repopulate both dropdowns fully
            repopulateUnlinkedMoveDropdowns();
        }

        filterAndSortPokemon();
    });



    // Radio button filters
    elements.filterShiny.addEventListener('change', filterAndSortPokemon);
    elements.filterLucky.addEventListener('change', filterAndSortPokemon);
    elements.filterShadow.addEventListener('change', filterAndSortPokemon);
    elements.filterPurified.addEventListener('change', filterAndSortPokemon);
    elements.filterHundo.addEventListener('change', filterAndSortPokemon);
    elements.filterNundo.addEventListener('change', filterAndSortPokemon);
    elements.filterNickname.addEventListener('change', filterAndSortPokemon);
    elements.filterNone.addEventListener('change', filterAndSortPokemon);
    
    document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("filterForm").addEventListener("change", () => {
        document.getElementById("filterAltFormsOnly").checked = false;
        filterAndSortPokemon();
    });

    document.getElementById("filterCostume").addEventListener("change", () => {
        document.getElementById("filterCostumedOnly").checked = false;
        filterAndSortPokemon();
    });
    });

    
    // Advanced filters toggle
    elements.advancedFiltersToggle.addEventListener('change', function() {
        elements.advancedFiltersContainer.classList.toggle('hidden', !this.checked);
    });
    
    // Advanced filter changes
    elements.cpMin.addEventListener('input', filterAndSortPokemon);
    elements.cpMax.addEventListener('input', filterAndSortPokemon);
    elements.attackMin.addEventListener('input', filterAndSortPokemon);
    elements.attackMax.addEventListener('input', filterAndSortPokemon);
    elements.defenceMin.addEventListener('input', filterAndSortPokemon);
    elements.defenceMax.addEventListener('input', filterAndSortPokemon);
    elements.staminaMin.addEventListener('input', filterAndSortPokemon);
    elements.staminaMax.addEventListener('input', filterAndSortPokemon);

    
    // Selection tools
    elements.selectAllBtn.addEventListener('click', selectAllVisible);
    elements.deselectAllBtn.addEventListener('click', deselectAll);
    
    // Load more button
    elements.loadMoreBtn.addEventListener('click', function() {
        displayPokemon(false);
    });
    
    window.addEventListener('scroll', function () {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
            displayPokemon(false);
        }
    });
    
    // Upload JSON file
    // elements.uploadJsonBtn.addEventListener('click', function() {
    //     const fileInput = document.createElement('input');
    //     fileInput.type = 'file';
    //     fileInput.accept = '.json';
    //     fileInput.onchange = handleFileUpload;
    //     fileInput.click();
    // });
    elements.uploadJsonBtn.addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const match = file.name.match(/^Pokemons-(.+)-(\d{2}-\d{2}-\d{4})\.json$/);
        if (!match) {
            alert("Invalid file format. Must be: Pokemons-ACCOUNTNAME-dd-mm-yyyy.json");
            return;
        }

        const [_, accountName, date] = match;
        const text = await file.text();
        const json = JSON.parse(text);

        if (!uploadedFiles[accountName]) uploadedFiles[accountName] = [];
        uploadedFiles[accountName].push({ date, data: json });

        updateAccountDropdown();
        loadPokemonData(json);  // Assuming you have a function like this
    };
    input.click();
});
function updateAccountDropdown() {
    const dropdown = document.getElementById('accountSelector');
    dropdown.innerHTML = '<option value="">Select Account</option>';

    Object.keys(uploadedFiles).forEach(account => {
        const option = document.createElement('option');
        option.value = account;
        option.textContent = account;
        dropdown.appendChild(option);
    });
}
document.getElementById('accountSelector').addEventListener('change', function () {
    const accountName = this.value;
    if (!accountName || !uploadedFiles[accountName]) return;

    // For now, load the latest upload for the account
    const latest = uploadedFiles[accountName].slice(-1)[0];
    loadPokemonData(latest.data);
});


    // Load sample data
    elements.loadSampleDataBtn.addEventListener('click', loadSampleData);
    
    // Export selected
    elements.exportSelectedBtn.addEventListener('click', exportSelectedPokemon);
    
    // Modal close
    elements.closeModal.addEventListener('click', function() {
        elements.pokemonModal.classList.add('hidden');
    });
    
    elements.closeModalBtn.addEventListener('click', function() {
        elements.pokemonModal.classList.add('hidden');
    });
    // Ensure all <select> dropdowns trigger filtering and stats update
    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', filterAndSortPokemon);
    });

    
    // Close modal when clicking outside
    elements.pokemonModal.addEventListener('click', function(event) {
        if (event.target === elements.pokemonModal) {
            elements.pokemonModal.classList.add('hidden');
        }
    });
    
    // Keyboard events
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !elements.pokemonModal.classList.contains('hidden')) {
            elements.pokemonModal.classList.add('hidden');
        }
    });
    
    document.querySelectorAll('.alpha-nav li').forEach(li => {
        li.addEventListener('click', () => {
            const letter = li.dataset.letter.toUpperCase();
            const targetCard = Array.from(document.querySelectorAll('.pokemon-card')).find(card => {
                const name = card.querySelector('.pokemon-name')?.textContent?.trim()?.toUpperCase();
                return name?.startsWith(letter);
            });

            if (targetCard) {
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
}

// Initialize the app
function init() {
    setupEventListeners();
    
    // Add file reader element for uploads (hidden)
    const fileReader = document.createElement('input');
    fileReader.type = 'file';
    fileReader.id = 'fileInput';
    fileReader.accept = '.json';
    fileReader.style.display = 'none';
    document.body.appendChild(fileReader);
    
    // Show initial message
    elements.pokemonGrid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: #777;">
            <p>Welcome to the Pok√©mon GO Collection Viewer!</p>
            <p>To get started, click "Load Sample Data" or "Upload JSON File".</p>
        </div>
    `;
}

// Clear all special filters when None is pressed //
function clearSpecialFilters() {
    const filters = [
        'filterShiny',
        'filterLucky',
        'filterShadow',
        'filterPurified',
        'filterHundo',
        'filterNundo',
        'filterNickname'
    ];

    filters.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = false;
    });

    // Also clear All Forms and All Costumes buttons
    const altFormsBtn = document.getElementById('filterAltFormsOnly');
    const costumedBtn = document.getElementById('filterCostumedOnly');

    if (altFormsBtn) {
        altFormsBtn.classList.remove('active');
        window.filterAltFormsOnlyState = false;
    }

    if (costumedBtn) {
        costumedBtn.classList.remove('active');
        window.filterCostumedOnlyState = false;
    }

    filterAndSortPokemon();
}


const dropdowns = document.querySelectorAll('select');
dropdowns.forEach(select => {
    select.addEventListener('change', () => {
        filterAndSortPokemon(); // includes updateStats()
    });
});



// Start the app when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
</script>

<div id="searchHelpModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Search Tips</h2>
      <button class="close-modal" onclick="closeSearchHelpModal()">√ó</button>
    </div>
    <div class="modal-body">
      <ul style="line-height: 1.8;">
        <li><strong>Name Match:</strong> <code>pikachu</code> ‚Üí matches names or nicknames containing "pikachu"</li>
        <li><strong>Exact Match:</strong> <code>"mewtwo"</code> ‚Üí matches exactly "mewtwo"</li>
        <li><strong>Number:</strong> <code>150</code> ‚Üí matches Pok√©dex #150</li>
        <li><strong>Range:</strong> <code>1-151</code> ‚Üí matches Gen 1 Pok√©mon</li>
        <li><strong>Multiple:</strong> <code>pikachu,eevee</code> ‚Üí OR match for name or nickname</li>
        <li><strong>Negative Match:</strong> <code>!rattata</code> ‚Üí excludes matches</li>
        <li><strong>AND:</strong> <code>electric & shiny</code> ‚Üí must match both</li>
        <li><strong>Generation:</strong> <code>gen1</code> or <code>gen3</code> ‚Üí by region</li>
        <li><strong>Hover:</strong> <code>hover over a 'mons card for more info</li>
      </ul>
    </div>
    <div class="modal-footer">
      <button onclick="closeSearchHelpModal()">Close</button>
    </div>
  </div>
</div>
</body>

</html>